/*********************************************************************/
/*                                                                   */
/*  This Program Written by Paul Edwards.                            */
/*  Released to the Public Domain                                    */
/*                                                                   */
/*********************************************************************/
/*********************************************************************/
/*                                                                   */
/*  instmbr - install an MBR (master boot record) at LBA sector 0    */
/*                                                                   */
/*********************************************************************/

/* Utility bin2hex in ozpd was used to generate the hex values
   from the "compmbr" output */

#include <stdio.h>
#include <stdlib.h>

#include "pos.h"
#include "unused.h"

int main(int argc, char **argv)
{
    static unsigned char mbr[440] = {
    "\xFA\x33\xC0\x8E\xD8\x8E\xC0\x8E\xD0\xBC\x00\x7C\xFB\xBE\x00\x7C"
    "\xBF\x00\x06\xB9\x00\x01\xF3\xA5\xB8\x00\x00\x50\xB8\x40\x06\x50"
    "\xCB\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x10\x00\x01\x00\x00\x7C\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\xBE\xBE\x07\xB9\x04\x00\xF6\x04\x80\x75\x0A\x83\xC6\x10\xE2\xF6"
    "\xBD\xBE\x06\xEB\x5A\x80\x7C\x04\x00\xBD\xD9\x06\x74\x51\xB4\x41"
    "\xBB\xAA\x55\xCD\x13\xBD\x06\x07\x72\x45\x81\xFB\x55\xAA\x75\x3F"
    "\x8B\x44\x08\xA3\x38\x06\x8B\x44\x0A\xA3\x3A\x06\xB9\x0A\x00\x56"
    "\xB4\x42\xBE\x30\x06\xCD\x13\x73\x0B\xB4\x00\xCD\x13\xE2\xF1\xBD"
    "\x2C\x07\xEB\x1B\x5E\x26\x81\x3E\xFE\x7D\x55\xAA\xBD\x4F\x07\x75"
    "\x0E\x8B\xEE\xB8\x00\x00\x50\xB8\x00\x7C\x50\xCB\xCD\x10\x45\xB4"
    "\x0E\x8A\x46\x00\x3C\x00\x75\xF4\x87\xDB\xFB\xF4\xEB\xFA\x4E\x6F"
    "\x20\x61\x63\x74\x69\x76\x65\x20\x70\x61\x72\x74\x69\x74\x69\x6F"
    "\x6E\x20\x66\x6F\x75\x6E\x64\x21\x00\x41\x63\x74\x69\x76\x65\x20"
    "\x70\x61\x72\x74\x69\x74\x69\x6F\x6E\x20\x68\x61\x73\x20\x69\x6E"
    "\x76\x61\x6C\x69\x64\x20\x70\x61\x72\x74\x69\x74\x69\x6F\x6E\x20"
    "\x74\x79\x70\x65\x21\x00\x42\x49\x4F\x53\x20\x64\x6F\x65\x73\x20"
    "\x6E\x6F\x74\x20\x73\x75\x70\x70\x6F\x72\x74\x20\x4C\x42\x41\x20"
    "\x65\x78\x74\x65\x6E\x73\x69\x6F\x6E\x73\x21\x00\x46\x61\x69\x6C"
    "\x65\x64\x20\x74\x6F\x20\x72\x65\x61\x64\x20\x76\x6F\x6C\x75\x6D"
    "\x65\x20\x62\x6F\x6F\x74\x20\x72\x65\x63\x6F\x72\x64\x21\x00\x56"
    "\x6F\x6C\x75\x6D\x65\x20\x62\x6F\x6F\x74\x20\x72\x65\x63\x6F\x72"
    "\x64\x20\x69\x73\x20\x6E\x6F\x74\x20\x62\x6F\x6F\x74\x61\x62\x6C"
    "\x65\x20\x28\x6D\x69\x73\x73\x69\x6E\x67\x20\x30\x78\x61\x61\x35"
    "\x35\x20\x62\x6F\x6F\x74\x20\x73\x69\x67\x6E\x61\x74\x75\x72\x65"
    "\x29\x21\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00"
    };
    unsigned char buf[512];
    int drive;
    unsigned long sect = 0;
    int rc;
    
    if (argc <= 1)
    {
        printf("usage: instmbr <drive>\n");
        printf("example: instmbr 81\n");
        printf("which will install to the second hard disk, typically,\n");
        printf("but not necessarily, the D drive\n");
        printf("80 = first, 81 = second, 82 = third, 83 = fourth\n");
        return (EXIT_FAILURE);
    }
    
    drive = strtol(*(argv + 1), NULL, 16);
    rc = PosAbsoluteDriveRead(drive, sect, 1, buf);

    if (rc != 0)
    {
        printf("read failed with rc %d\n", rc);
        return (EXIT_FAILURE);
    }

    memcpy(buf, mbr, sizeof mbr);

    rc = PosAbsoluteDriveWrite(drive, sect, 1, buf);

    if (rc != 0)
    {
        printf("write failed with rc %d\n", rc);
        return (EXIT_FAILURE);
    }

    printf("MBR has been written to drive %x\n", drive);
    return (0);
}
